import { GoogleGenerativeAI } from "@google/generative-ai";
import { NextResponse } from "next/server";

// ============================================================================
// [route.ts] - Gemini AI ì±„íŒ… API ì—”ë“œí¬ì¸íŠ¸
// ============================================================================
// ì´ íŒŒì¼ì€ ChatWidgetì—ì„œ ë³´ë‚¸ ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ë°›ì•„
// Google Gemini AIë¡œ ì‘ë‹µì„ ìƒì„±í•˜ëŠ” API ë¼ìš°íŠ¸ì…ë‹ˆë‹¤.
// ê²½ë¡œ: POST /api/chat
// ============================================================================

export async function POST(req: Request) {
    try {
        // ============================================================================
        // ğŸ”§ [ìˆ˜ì • í¬ì¸íŠ¸ #1] API í‚¤ ì„¤ì •
        // ============================================================================
        // .env.local íŒŒì¼ì˜ GEMINI_API_KEY í™˜ê²½ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        // ë˜ëŠ” ì•„ë˜ ë¬¸ìì—´ì— ì§ì ‘ API í‚¤ë¥¼ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        // Google AI Studioì—ì„œ API í‚¤ë¥¼ ë°œê¸‰ë°›ìœ¼ì„¸ìš”: https://aistudio.google.com/
        // ============================================================================
        const apiKey = process.env.GEMINI_API_KEY || "AIzaSyC0Vii04IKCyU7OexPT0xEa2SGfq2jyqEs";

        if (!apiKey) {
            return NextResponse.json(
                { error: "API Key not configured" },
                { status: 500 }
            );
        }

        const genAI = new GoogleGenerativeAI(apiKey);

        // ============================================================================
        // ğŸ”§ [ìˆ˜ì • í¬ì¸íŠ¸ #2] AI ëª¨ë¸ ì„ íƒ
        // ============================================================================
        // ì‚¬ìš©í•  Gemini ëª¨ë¸ì„ ì§€ì •í•©ë‹ˆë‹¤.
        // ì˜µì…˜: "gemini-2.5-flash", "gemini-1.5-pro" ë“±
        // ì°¸ê³ : https://ai.google.dev/models/gemini
        // ============================================================================
        const modelName = "gemini-2.5-flash";

        const body = await req.json();
        const { userQuery, context } = body;

        // ============================================================================
        // ğŸ”§ [ìˆ˜ì • í¬ì¸íŠ¸ #3] ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (AI ì„±ê²©/ì—­í•  ì„¤ì •)
        // ============================================================================
        // ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ ìˆ˜ì •í•˜ë©´ AIì˜ ì‘ë‹µ ìŠ¤íƒ€ì¼ê³¼ ì—­í• ì´ ë³€ê²½ë©ë‹ˆë‹¤.
        // - íšŒì‚¬ ì •ë³´, ì œí’ˆ ì •ë³´, ì‘ë‹µ ê·œì¹™ ë“±ì„ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        // ============================================================================
        const systemInstructionText = `ë‹¹ì‹ ì€ í•œë¯¸ë¥´(ì£¼)ì˜ ê¸°ìˆ  ì˜ì—… AI ì–´ì‹œìŠ¤í„´íŠ¸ì¸ 'HANMIR AI'ì…ë‹ˆë‹¤.
    
        ë‹¹ì‹ ì˜ ì–´ì¡°: ì „ë¬¸ì ì´ê³  ì‹ ë¢°ê° ìˆìœ¼ë©°, ê°„ê²°í•˜ê³  ëª…í™•í•˜ê²Œ ë‹µë³€í•˜ì‹­ì‹œì˜¤.
        ë‹¹ì‹ ì˜ ëª©í‘œ: ì—”ì§€ë‹ˆì–´ ë° êµ¬ë§¤ ë‹´ë‹¹ìê°€ í•œë¯¸ë¥´ì˜ ê¸°ëŠ¥ì„± ë„ë£Œ ê¸°ìˆ ì„ ì´í•´í•˜ë„ë¡ ë•ëŠ” ê²ƒì…ë‹ˆë‹¤.
        
        íšŒì‚¬ ì •ë³´ (Context):
        - í•œë¯¸ë¥´(ì£¼)ëŠ” ê³ ê¸°ëŠ¥ì„± íŠ¹ìˆ˜ ë„ë£Œ ì „ë¬¸ ê¸°ì—…ì…ë‹ˆë‹¤.
        - ì£¼ìš” ì œí’ˆ: ë¶ˆì—° ì½”íŒ…ì œ, ë°©ì—´(Heat Dissipation) í˜ì¸íŠ¸, ì „ìíŒŒ ì°¨í(EMI Shielding) ë„ë£Œ, ê³ ë‚´ì—´ì„± ì„¸ë¼ë¯¹ ì½”íŒ…ì œ.
        - í•µì‹¬ ê°€ì¹˜: "í˜ì‹ ", "ì•ˆì „", "ì¹œí™˜ê²½", "ì´ˆë‚´êµ¬ì„±".
        - í˜„ì¬ ì‚¬ìš©ì ìƒí™©: ${context || "ì¼ë°˜ ë¬¸ì˜"}
        
        ë‹µë³€ ê·œì¹™:
        1. í•œêµ­ì–´ë¡œ ë‹µë³€í•˜ì‹­ì‹œì˜¤.
        2. ê°€ê²© ë¬¸ì˜ ì‹œ "ìƒì„¸ ê²¬ì ì€ ì˜ì—…íŒ€ì— ì§ì ‘ ë¬¸ì˜í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤."ë¼ê³  ì•ˆë‚´í•˜ì‹­ì‹œì˜¤.
        3. ìƒì„¸í•œ ê¸°ìˆ  ì‚¬ì–‘ ìš”ì²­ì´ ì•„ë‹Œ ê²½ìš° 3ë¬¸ì¥ ì´ë‚´ë¡œ ë‹µë³€í•˜ì‹­ì‹œì˜¤.
        4. ë‹¹ì‹ ì˜ ë‹µë³€ì€ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì„ ì§€ì›í•©ë‹ˆë‹¤.`;

        const model = genAI.getGenerativeModel({
            model: modelName,
            systemInstruction: systemInstructionText,
        });

        console.log(`Model initialized: ${modelName}`);

        // ëŒ€í™” íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™” (ì²« ì¸ì‚¬ ë©”ì‹œì§€ìš©)
        const chat = model.startChat({
            history: [
                {
                    role: "user",
                    parts: [{ text: "ì¸ì‚¬ë¥¼ ë¶€íƒí•´." }],
                },
                {
                    role: "model",
                    parts: [{ text: "ë°˜ê°‘ìŠµë‹ˆë‹¤. í•œë¯¸ë¥´(ì£¼) ê¸°ìˆ  ì˜ì—… AIì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?" }],
                }
            ],
        });

        // ì‚¬ìš©ì ë©”ì‹œì§€ ì „ì†¡ ë° ì‘ë‹µ ë°›ê¸°
        const result = await chat.sendMessage(userQuery);
        const response = await result.response;
        const text = response.text();

        console.log("Response generated successfully");

        return NextResponse.json({ text });

    } catch (error: any) {
        console.error("Gemini API Error Full Details:", JSON.stringify(error, null, 2));

        return NextResponse.json(
            { error: `Gemini Error: ${error.message}` },
            { status: 500 }
        );
    }
}